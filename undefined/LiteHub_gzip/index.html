<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Qingyh">
    
    <title>
        
            分类: LiteHub |
        
        阿寒的学习笔记
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/blog.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/brands.min.css">
    
        
            
        
            
                
<link rel="stylesheet" href="/css/custom.css">

            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"localhost","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"阿寒的学习笔记","author":"Qingyh","avatar":"/images/profile.svg","logo":"/images/blog.svg","favicon":"/images/blog.svg"},"menu":{"home":"/                      || fa-solid fa-home","archives":"/archives          || fa-solid fa-box-archive","tags":"/tags                  || fa-solid fa-tags","categories":"/categories      || fa-solid fa-layer-group","links":"/links                || fa-solid fa-link","tools":"/tools                || fa-solid fa-tools","about":"/about                || fa-solid fa-user-graduate"},"first_screen":{"enable":true,"background_img":"/images/bg.png","background_img_dark":"/images/bg.png","description":"知识的学习在于点滴记录，坚持不懈 || 要有深度和广度，不仅要能够理解，更知道如何表达！！！","hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/qingyh6","weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null,"csdn":"https://blog.csdn.net/weixin_52288941?type=blog"}},"scroll":{"progress_bar":true,"percent":false,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":false},"datetime_format":"YYYY 年 MM 月 DD 日 HH:mm","copyright_info":false,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":true,"css":[null,"/css/custom.css"],"js":[null]},"root":"","source_data":{"links":[{"title":"我的其他平台"},{"name":"github","link":"https://github.com/qingyh6","description":"懒惰是程序员第一生产力","avatar":"/images/github.svg"},{"name":"CSDN","link":"https://blog.csdn.net/weixin_52288941?type=blog","description":"善于思考；勤于记录","avatar":"/images/csdn.svg"}],"icons":{"csdn":{"svg":"<svg t=\"1752285352594\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"4369\" width=\"16\" height=\"16\"><path d=\"M512 1024C229.222 1024 0 794.778 0 512S229.222 0 512 0s512 229.222 512 512-229.222 512-512 512z m17.067-413.525c34.85 4.352 68.778 5.12 102.741 2.099 23.04-2.048 44.817-8.363 64.17-21.914 38.213-26.794 49.784-85.197 24.252-123.05-14.626-21.71-36.812-30.345-60.757-35.5-35.055-7.543-70.451-5.75-105.847-3.412-5.667 0.358-6.759 3.072-7.237 8.209-3.072 32.682-6.536 65.314-9.813 97.962-2.509 24.815-4.932 49.63-7.51 75.606z m53.401-33.929c1.963-20.907 3.635-39.339 5.427-57.77 1.554-15.907 3.414-31.779 4.728-47.702 0.358-4.284 1.553-6.656 5.956-6.383 15.616 1.041 31.71 0.034 46.729 3.652 36.488 8.824 48.725 54.307 23.347 83.03-15.82 17.903-36.762 23.586-59.256 25.088-8.465 0.546-17.015 0.085-26.93 0.085zM512 434.296c-2.185-0.65-3.533-1.178-4.932-1.434-37.718-6.878-75.69-8.329-113.647-2.816-20.975 3.038-41.011 9.489-57.48 23.33-22.99 19.32-21.641 46.848 4.402 62.003 13.056 7.595 28.024 12.51 42.599 17.289 14.08 4.608 28.996 6.826 43.144 11.264 12.596 3.925 14.012 14.319 3.584 22.306-3.345 2.56-7.44 5.086-11.537 5.751-11.195 1.826-22.698 4.386-33.826 3.567-24.098-1.775-48.042-5.461-72.55-8.43-1.366 10.615-2.936 23.09-4.557 35.942 4.181 1.365 7.68 2.73 11.264 3.618 33.946 8.5 68.386 9.608 102.912 5.12 20.087-2.611 39.475-7.902 56.695-19.03 28.604-18.483 36.694-57.19-4.676-75.383-14.506-6.383-30.19-10.41-45.482-15.087-11.418-3.481-23.314-5.615-34.526-9.523-9.78-3.413-11.145-12.203-3.038-18.398 4.659-3.55 10.718-6.997 16.384-7.373a480.853 480.853 0 0 1 53.384-0.853c15.377 0.7 30.652 3.55 46.49 5.53L512 434.295z m257.143 2.047l-18.21 177.955h54.153c4.779-45.637 9.71-90.727 14.063-135.885 0.614-6.366 2.355-8.84 8.687-9.011 11.434-0.273 22.886-1.98 34.287-1.57 23.722 0.853 42.393 9.727 38.4 43.263-2.902 24.27-5.598 48.572-8.244 72.875-1.092 10.07-1.826 20.19-2.73 30.413h55.33c3.584-35.26 7.987-70.059 10.496-104.994 3.413-47.463-17.766-73.319-64.683-80.214-40.96-6.007-81.34-0.34-121.549 7.134zM285.645 570.948c-8.738 1.297-16.384 2.8-24.098 3.482-25.652 2.236-51.32 3.942-76.305-4.267-13.91-4.59-24.679-12.578-29.799-25.958-7.902-20.702 0.888-47.104 19.832-60.314 17.374-12.117 37.717-15.923 58.453-15.923 22.545-0.017 45.09 2.423 68.233 3.84l5.239-39.51c-15.07-1.723-29.491-3.925-43.998-4.915-41.011-2.798-80.64 2.612-117.47 20.463-30.02 14.558-52.053 36.011-58.675 68.13-7.85 38.145 11.537 69.496 51.763 85.846 19.15 7.765 39.288 12.51 60.007 12.595 24.746 0.102 49.493-1.57 74.206-2.952 3.106-0.171 8.311-2.902 8.67-5.035 1.98-11.554 2.73-23.28 3.942-35.465z\" fill=\"#2c2c2c\" p-id=\"4370\"></path></svg>","link":"https://blog.csdn.net/weixin_52288941?type=blog"}},"photos":[{"url":"https://xpoet.cn/images/logo.png","name":"XPoet"},{"url":"/images/photos/img-1.png","name":"img1"},{"url":"/images/photos/img-2.png","name":"img2"},"......","......","......"],"tools":[{"title":"我的常用工具"},{"category":"聊天 AI","anchorId":"JUU4JTgxJThBJUU1JUE0JUE5JTIwQUk1"},{"name":"deepseek","link":"https://www.deepseek.com/","description":"国产大模型","image":"/images/deepseek.svg"},{"name":"ChatGPT","link":"https://chat.openai.com/","description":"OpenAI 旗下 AI 聊天对话工具","image":"/images/chatgpt.svg"},{"name":"kimi","link":"https://www.kimi.com/","description":"会推理解析，能深度思考的深度助手","image":"/images/kimi.svg"},{"category":"编程助手","anchorId":"JUU3JUJDJTk2JUU3JUE4JThCJUU1JThBJUE5JUU2JTg5JThC5"},{"name":"豆包","link":"https://www.trae.cn/plugin","description":"清理灵活，你的AI编程助手","image":"/images/doubao.svg"},{"name":"cursor","link":"https://cursor.com/cn","description":"AI代码编辑器","image":"/images/cursor.svg"}]},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/blog.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               阿寒的学习笔记
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/links">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-link"></i>
                                
                                友链
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tools">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tools"></i>
                                
                                工具
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/about">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-user-graduate"></i>
                                
                                关于
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/links">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-link"></i>
                                </span>
                            
                            友链
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tools">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tools"></i>
                                </span>
                            
                            工具
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/about">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-user-graduate"></i>
                                </span>
                            
                            关于
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        LiteHub之gzip压缩算法
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/profile.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Qingyh</span>
                                
                                    <span class="author-badge">Lv2</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025 年 07 月 05 日 10:28</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Sat Jul 12 2025 13:50:16 GMT+0800">2025 年 07 月 12 日 13:50</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Http%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8/">Http后端服务器</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E7%BD%91%E7%BB%9C/">网络</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%90%8E%E7%AB%AF/">后端</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>3.9k 字</span>
            </span>
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <meta name="referrer" content="no-referrer"/>

<h2 id="理论部分"><a href="#理论部分" class="headerlink" title="理论部分"></a>理论部分</h2><blockquote>
<p>gzip是一种无损压缩算法，其基础为Deflate，Deflate是LZ77与哈弗曼编码的一个组合体。它的基本原理是：对于要压缩的文件，首先使用LZ77算法的一个变种进行压缩，对得到的结果再使用哈夫曼编码（根据情况，使用静态哈弗曼编码或动态哈夫曼编码）的方法进行压缩。</p>
</blockquote>
<h3 id="LZ777算法"><a href="#LZ777算法" class="headerlink" title="LZ777算法"></a>LZ777算法</h3><p>几个术语</p>
<ul>
<li>等待编码区</li>
<li>搜索缓冲区（已经编码的区域）</li>
<li>滑动窗口（指定大小，包括“搜索缓冲区”和“待编码区”）</li>
</ul>
<p>具体的编码过程：<br>接下来，介绍具体的编码过程：<br>　　为了编码待编码区， 编码器在滑动窗口的搜索缓冲区查找直到找到匹配的字符串。匹配字符串的开始字符串与待编码缓冲区的距离称为“偏移值”，匹配字符串的长度称为“匹配长度”。<br>　　编码器在编码时，会一直在搜索区中搜索，直到找到最大匹配字符串，并输出(o, l )，其中o是偏移值， l是匹配长度。然后窗口滑动l，继续开始编码。<br>　　如果没有找到匹配字符串，则输出(0, 0, c)，c为待编码区下一个等待编码的字符，窗口滑动“1”。</p>
<p>参考文章：<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/junyuhuang/p/4138376.html" >LZ77压缩算法编码原理详解(结合图片和简单代码)<i class="fas fa-external-link-alt"></i></a></p>
<p>下面我们以字符串“<code>abababc</code>”为例，来了解其编码过程：</p>
<p>假设滑动窗口的大小足够大(LZ777设置的滑动窗口是32k)，可以覆盖整个字符串。</p>
<p><strong>第一步</strong>：<br>	&emsp;待编码区：abababc<br>	&emsp;搜索缓冲区：（初始为空）<br>	&emsp;操作：搜索缓冲区为空，无法找到匹配字符串。<br>	&emsp;输出：(0, 0, a)（表示没有找到匹配，输出字符a）<br>	&emsp;窗口滑动：窗口向右滑动1个字符。<br>	&emsp;结果：a已经被编码，剩下bababc。<br><strong>第二步</strong>：<br>	&emsp;待编码区：bababc<br>	&emsp;搜索缓冲区：a（已经编码的部分）<br>	&emsp;操作：在搜索缓冲区中查找b的匹配。搜索缓冲区中没有b。<br>	&emsp;输出：(0, 0, b)（表示没有找到匹配，输出字符b）<br>	&emsp;窗口滑动：窗口向右滑动1个字符。<br>	&emsp;结果：ab已经被编码，剩下ababc。<br><strong>第三步</strong>：<br>	&emsp;待编码区：ababc<br>	&emsp;搜索缓冲区：ab（已经编码的部分）<br>	&emsp;操作：在搜索缓冲区中查找ab的匹配。搜索缓冲区中存在ab，匹配长度为2。<br>	&emsp;输出：(2, 2)（表示匹配长度为2，偏移值为2）<br>	&emsp;窗口滑动：窗口向右滑动2个字符。<br>	&emsp;结果：abab已经被编码，剩下abc。<br><strong>第四步</strong>：<br>	&emsp;待编码区：abc<br>	&emsp;搜索缓冲区：abab（已经编码的部分）<br>	&emsp;操作：在搜索缓冲区中查找ab的匹配。搜索缓冲区中存在ab，匹配长度为2。<br>	&emsp;输出：(4, 2)（表示匹配长度为2，偏移值为4）<br>	&emsp;窗口滑动：窗口向右滑动2个字符。<br>	&emsp;结果：ababab已经被编码，剩下c。<br><strong>第五步</strong>：<br>	&emsp;待编码区：c<br>	&emsp;搜索缓冲区：ababab（已经编码的部分）<br>	&emsp;操作：在搜索缓冲区中查找c的匹配。搜索缓冲区中没有c。<br>	&emsp;输出：(0, 0, c)（表示没有找到匹配，输出字符c）<br>	&emsp;窗口滑动：窗口向右滑动1个字符。<br>	&emsp;结果：整个字符串已经编码完成。</p>
<p><strong>最终编码结果</strong><br>&emsp;经过上述步骤，字符串abababc的LZ77编码结果为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0</span>, <span class="number">0</span>, a) (<span class="number">0</span>, <span class="number">0</span>, b) (<span class="number">2</span>, <span class="number">2</span>) (<span class="number">4</span>,<span class="number">2</span>) (<span class="number">0</span>, <span class="number">0</span>, c)</span><br></pre></td></tr></table></figure>
<p>使用<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/junyuhuang/p/4138376.html" >LZ77压缩算法编码原理详解(结合图片和简单代码)<i class="fas fa-external-link-alt"></i></a>给定的代码的编码结果是<br><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/fec766beb7344418952a7b715d53c1ea.png"
                        alt="在这里插入图片描述"
                 ><br>说明上述编码过程分析正确！！！</p>
<p>上面的如(0, 0, a)这个其实根本不用写偏移和匹配长度，保留为原字符‘a’，占的编码长度还更短一些。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0</span>, <span class="number">0</span>, a) (<span class="number">0</span>, <span class="number">0</span>, b) (<span class="number">2</span>, <span class="number">2</span>) (<span class="number">4</span>,<span class="number">2</span>) (<span class="number">0</span>, <span class="number">0</span>, c)</span><br></pre></td></tr></table></figure>
<p>变为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ab</span>(<span class="number">2</span>, <span class="number">2</span>) (<span class="number">4</span>,<span class="number">2</span>)c</span><br></pre></td></tr></table></figure>
<h3 id="霍夫曼编码算法"><a href="#霍夫曼编码算法" class="headerlink" title="霍夫曼编码算法"></a>霍夫曼编码算法</h3><p>霍夫曼编码是一种基于字符频率的变长编码方法，通过构建霍夫曼树来为每个字符分配一个唯一的二进制编码。霍夫曼树的构建过程依赖于字符的频率，频率越高的字符通常会被分配较短的编码。<br>首先我们统计”<code>abababc</code>“中每一个字符出现的频率，如下所示</p>
<table>
<thead>
<tr>
<th align="center">a</th>
<th align="center">b</th>
<th align="center">c</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>根据霍夫曼编码的规则，我们需要按照字符频率从低到高构建霍夫曼树。以下是构建过程：</p>
<ol>
<li>将字符串出现的频率视为优先级，放入一个最小优先队列中：</li>
</ol>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/66beb0047e2b4dcc946eab5d59ab0559.png"
                        alt="在这里插入图片描述"
                 ></p>
<ol start="2">
<li>然后弹出两个优先级最低的字符作为子节点, 构造出第一个二叉树; 父节点的优先级视为两个字节优先级之和, 然后把父节点插入队列中:<br><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/9488cb0dd1ed4da19e59aa5f48a6253d.png"
                        alt="在这里插入图片描述"
                 ></li>
<li>重复这个操作, 最后我们会得到一颗二叉树. 这便是 Huffman编码 树.</li>
</ol>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/55978a3216824675b8365a88eade715c.png"
                        alt="在这里插入图片描述"
                 ><br>4.  我们把这棵树的左支编码为 0, 右支编码为 1, 那么从根节点向下遍历到叶子节点, 即可得出相应字符的 Huffman 编码. 因此我们得到上面例子的 Huffman 编码表为:<br><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/9b87beeda7f94b32b341d27d9c89286e.png"
                        alt="在这里插入图片描述"
                 ></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span></span><br><span class="line">b:<span class="number">01</span></span><br><span class="line">c:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>现在对字符串中出现的频率都做了一个统计，只需要解决偏移量和匹配长度的编码就可以了。</p>
<p> DEFLATE 算法对偏移距离和匹配长度已经做了一个统计，见下表：<br> <strong>偏移距离</strong>：<br> 它有 0 至 29 一共 30 个编码. 距离编码的含义如下表所示:<br> <img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/3b80d2f91e264311a064a808f2b952ae.png"
                        alt="在这里插入图片描述"
                 ></p>
<ul>
<li>code表示基本的编码表示，比如编码9对应的基准距离是25</li>
<li>extra表示距离基准距离偏移了多少，编码9对应的extra为3位，最大为111（7），即25+7，最大可以表示32。</li>
<li>distance，可以表示的距离范围<br><code>总结</code>：code+extra可以灵活表示distance的任何数字</li>
</ul>
<p> <strong>匹配长度</strong>：<br>对于长度, 它与普通字符共用同一编码空间. 这个编码空间一共有 286 个编码, 范围是从 0 至 285. 其中 0 至 255 为普通字符编码, 256 表示压缩块的结束; 而 257 至 285 则表示长度. 长度编码的含义如下表所示:<br><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/cbc0b2d8ccf74078ac743dd0dfead6e0.png"
                        alt="在这里插入图片描述"
                 ></p>
<p>与距离编码类似, 每个编码都表示一个或多个长度, 表示多个长度时后面会有 extra 位指示具体的长度. 长度编码能表示的长度范围为 3 至 258.<br>注意：所以在 DEFLATE 中，长度 1<del>2 的重复<strong>不会用匹配项表示</strong>（直接把这 1</del>2 个字节原样输出（即用字面值编码）通常比引用匹配（还要额外编码长度和距离）更短！）；只有长度 ≥ 3 时才会用匹配项 (length, distance) 来引用重复块。<br>解压时, 当读到编码小于等于 255, 则认为这是个普通字符, 原样输出即可; 若在 257 至 285 之间, 则说明遇到了一个重复标记, 这意味着当前编码表示的是长度, 且下一个编码表示的是距离. 解码得到长度和距离, 再在解压缓冲区中找到相应的部分输出即可; 若为 256, 则说明压缩块结束了.</p>
<p>从LZ777编码到霍夫曼编码<br>上一步的LZ777编码结果为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ab</span>(<span class="number">2</span>, <span class="number">2</span>) (<span class="number">4</span>,<span class="number">2</span>)c</span><br></pre></td></tr></table></figure>
<p>字符串统计频率为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span></span><br><span class="line">b:<span class="number">01</span></span><br><span class="line">c:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>字符编码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">101</span>(<span class="number">2</span>, <span class="number">2</span>) (<span class="number">4</span>,<span class="number">2</span>)<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>然后对偏移距离和匹配长度进行编码<br>但是这里发现匹配字符长度是从3开始的，那么这个2怎么编码呢？原来这里的deflate算法是使用了改进型的LZ777算法<br>参考文章：<a class="link"   target="_blank" rel="noopener" href="https://luyuhuang.tech/2020/04/28/gzip-and-deflate.html" >Gzip 格式和 DEFLATE 压缩算法<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="改进型的LZ777算法"><a href="#改进型的LZ777算法" class="headerlink" title="改进型的LZ777算法"></a>改进型的LZ777算法</h3><blockquote>
<p>LZ77压缩算法将所有数据都处理成为一个三元组串，每个三元组至少需要3个字节表示，如果在动态字典中未找到匹配字符串，会将1个字节输出为3个字节，这就导致了字节浪费。因此在DEFLATE算法中对其使用的LZ77算法进行了以下改进：</p>
<p>对匹配字符串长度小于3的字符串不压缩。因为长度小于3的字符串，使用三元组表示，对原始数据不能起到压缩的作用。<br>对字符串的匹配长度进行了限制，范围为（-128~127），用8bit表示，滑动窗口大小为32KB，用15bit表示，将压缩数据构造为标识+数据的形式，具体如表3所示。该存储方式，降低了压缩数据的存储空间。<br>由于只查找匹配长度大于3的字符串，为提高算法速度，在查找匹配字符串时，使用了哈希链结构搜索算法，其中哈希算法将3字节压缩到2字节，虽然哈希链结构存在搜索到错误结果的可能，但还是大幅提高了搜索速度。</p>
</blockquote>
<p>所以最终的编码结果为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span></span><br><span class="line">b:<span class="number">01</span></span><br><span class="line">c:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>这里的字符串“abababc”，连续匹配都没有超过三个字符，直接按照这个字符串常量进行编码即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10110110100</span></span><br></pre></td></tr></table></figure>

<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="压缩对象"><a href="#压缩对象" class="headerlink" title="压缩对象"></a>压缩对象</h3><p>在开始编写代码前，我们需要弄清楚，需要压缩的对象是什么？</p>
<ol>
<li>视频、音频、图片等文件本身就是压缩格式<br>mp4、jpg、png、avi、mp3 这些格 已经过复杂压缩算法处理（如 H.264、H.265、JPEG、LZ77 等）。<br>👉 所以再次使用 GZIP 压缩不会有太大效果，反而可能略微增加体积。</li>
<li>GZIP 对二进制内容的压缩效率很低<br>GZIP 是为文本内容设计的压缩算法（如 HTML、JSON、JavaScript 等）。<br>它依赖数据的可预测性和重复性（如文本中的重复词、空格等）来压缩。<br>视频文件的数据模式看起来是“随机的”，压缩器无法从中找到有效的模式。</li>
</ol>
<h3 id="gzip实现"><a href="#gzip实现" class="headerlink" title="gzip实现"></a>gzip实现</h3><p><code>GzipMiddleware.h</code>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">GzipMiddleware</span>():<span class="built_in">clientSupportGzip_</span>(<span class="literal">true</span>)&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">before</span><span class="params">(HttpRequest&amp; request)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">after</span><span class="params">(HttpResponse&amp; response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setClientSupportGzip</span><span class="params">(<span class="type">bool</span> flag)</span></span>&#123;clientSupportGzip_=flag;&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isClinetSupportGzip</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> clientSupportGzip_;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">getGzipEnableRate</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="type">uint64_t</span> total = totalRequests_.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">return</span> total == <span class="number">0</span> ? <span class="number">0.0</span> : (<span class="type">double</span>)gzipAppliedCount_.<span class="built_in">load</span>() / total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">getAverageCompressionRatio</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="type">uint64_t</span> original = originalSizeSum_.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">return</span> original == <span class="number">0</span> ? <span class="number">0.0</span> : (<span class="type">double</span>)compressedSizeSum_.<span class="built_in">load</span>() / original;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">compressGzip</span><span class="params">(<span class="type">const</span> std::string&amp; input, std::string&amp; output)</span></span>;</span><br><span class="line">    <span class="type">bool</span> clientSupportGzip_;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gzip统计信息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">checkArchive</span><span class="params">()</span></span>;  <span class="comment">// 检查是否需要归档</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resetStats</span><span class="params">()</span></span>;    <span class="comment">// 重置统计信息</span></span><br><span class="line">    std::atomic&lt;<span class="type">uint64_t</span>&gt; totalRequests_&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    std::atomic&lt;<span class="type">uint64_t</span>&gt; gzipAppliedCount_&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    std::atomic&lt;<span class="type">uint64_t</span>&gt; originalSizeSum_&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    std::atomic&lt;<span class="type">uint64_t</span>&gt; compressedSizeSum_&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// std::function&lt;void(uint64_t, uint64_t, uint64_t, uint64_t)&gt; archiveCallback_;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint64_t</span> MAX_REQUESTS_BEFORE_ARCHIVE = <span class="number">1e9</span>;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">uint64_t</span> MAX_ORIGINAL_SIZE_BEFORE_ARCHIVE = <span class="number">1ULL</span> &lt;&lt; <span class="number">40</span>; <span class="comment">// 1 TB</span></span><br></pre></td></tr></table></figure>

<p><code>GzipMiddleware.cpp</code>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GzipMiddleware::before</span><span class="params">(HttpRequest&amp; request)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// 从客户端请求头中获取 Accept-Encoding 字段</span></span><br><span class="line">    std::string acceptEncoding=request.<span class="built_in">getHeader</span>(<span class="string">&quot;Accept-Encoding&quot;</span>);</span><br><span class="line">     <span class="comment">// 判断是否包含 &quot;gzip&quot; 关键字</span></span><br><span class="line">    <span class="comment">// 如果包含，说明客户端支持 gzip 压缩</span></span><br><span class="line">    <span class="comment">// 否则，不支持 gzip 压缩，如果不支持，就不进行gzip压缩</span></span><br><span class="line">    acceptEncoding.<span class="built_in">find</span>(<span class="string">&quot;gzip&quot;</span>) != std::string::npos?<span class="built_in">setClientSupportGzip</span>(<span class="literal">true</span>):<span class="built_in">setClientSupportGzip</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------------</span></span><br><span class="line"><span class="comment">// GzipMiddleware::after</span></span><br><span class="line"><span class="comment">//--------------------------------------</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GzipMiddleware::after</span><span class="params">(HttpResponse&amp; response)</span> </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// 统计总请求数（用于后续压缩统计归档）</span></span><br><span class="line">    totalRequests_++;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isClinetSupportGzip</span>())     <span class="comment">// 如果客户端不支持 gzip，则直接跳过压缩</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否应该压缩，消息体大于256字节并且消息类型是文本、html等类型才可以</span></span><br><span class="line">    <span class="comment">//对于视频、图片等已经使用了其他压缩算法进行压缩了的，就不再使用gzip进行压缩了</span></span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="built_in">isShouldGzipCompress</span>()) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取原始响应体内容</span></span><br><span class="line">    <span class="type">const</span> std::string&amp; rawBody = response.<span class="built_in">getBody</span>();</span><br><span class="line">    std::string compressed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用实际压缩方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compressGzip</span>(rawBody, compressed)) &#123;</span><br><span class="line">        <span class="comment">// LOG_INFO&lt;&lt;&quot;gzipAppliedCount_:&quot;&lt;&lt;gzipAppliedCount_.load()&lt;&lt;&quot;originalSizeSum_&quot;&lt;&lt;originalSizeSum_.load()&lt;&lt;&quot;compressedSizeSum_&quot;&lt;&lt;compressedSizeSum_.load();</span></span><br><span class="line">        gzipAppliedCount_++;</span><br><span class="line">        originalSizeSum_ += rawBody.<span class="built_in">size</span>();</span><br><span class="line">        compressedSizeSum_ +=compressed.<span class="built_in">size</span>();</span><br><span class="line">        response.<span class="built_in">addHeader</span>(<span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);  <span class="comment">// 添加响应头标识压缩格式为 gzip</span></span><br><span class="line">        response.<span class="built_in">setContentLength</span>(compressed.<span class="built_in">size</span>());    <span class="comment">// 更新 Content-Length 为压缩后大小</span></span><br><span class="line">        response.<span class="built_in">setBody</span>(compressed);                    <span class="comment">// 设置压缩后的响应体</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查是否需要归档统计信息</span></span><br><span class="line">    <span class="built_in">checkArchive</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------------</span></span><br><span class="line"><span class="comment">// GzipMiddleware::compressGzip实际的压缩处理算法</span></span><br><span class="line"><span class="comment">//--------------------------------------</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GzipMiddleware::compressGzip</span><span class="params">(<span class="type">const</span> std::string&amp; input, std::string&amp; output)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">int</span> CHUNK = <span class="number">16384</span>; </span><br><span class="line">    z_stream strm&#123;&#125;;    <span class="comment">//zlib 用于压缩的状态结构体，记录输入、输出缓冲区状态等</span></span><br><span class="line">    <span class="type">char</span> out[CHUNK];    <span class="comment">//输出缓冲区，用来暂存压缩后的数据块</span></span><br><span class="line"></span><br><span class="line">    strm.zalloc = Z_NULL;</span><br><span class="line">    strm.zfree = Z_NULL;</span><br><span class="line">    strm.opaque = Z_NULL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">deflateInit2</span>(&amp;strm,             <span class="comment">//压缩状态</span></span><br><span class="line">                     Z_BEST_COMPRESSION, <span class="comment">//压缩等级（0~9），9 表示最高压缩比，牺牲性能</span></span><br><span class="line">                     Z_DEFLATED,         <span class="comment">//使用 DEFLATE 算法</span></span><br><span class="line">                     <span class="number">15</span> + <span class="number">16</span>,           <span class="comment">//15位窗口大小(32KB), +16启用 GZIP 格式输出（否则是 zlib）</span></span><br><span class="line">                     <span class="number">8</span>,                 <span class="comment">//内部压缩缓冲区大小参数，一般为 8</span></span><br><span class="line">                     Z_DEFAULT_STRATEGY) != Z_OK) <span class="comment">//默认压缩策略</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    strm.avail_in = input.<span class="built_in">size</span>();          <span class="comment">// 待压缩数据长度</span></span><br><span class="line">    strm.next_in = (Bytef*)input.<span class="built_in">data</span>();   <span class="comment">// 待压缩数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        strm.avail_out = CHUNK;            <span class="comment">//待压缩数据存储buffer 的长度，如果多次写，会覆盖之前的写的数据</span></span><br><span class="line">                                            <span class="comment">//当然，之前的数据已经被读走了</span></span><br><span class="line">        strm.next_out = <span class="built_in">reinterpret_cast</span>&lt;Bytef*&gt;(out); <span class="comment">//待压缩数据存储的buffer</span></span><br><span class="line">        <span class="built_in">deflate</span>(&amp;strm, Z_FINISH);            <span class="comment">//如果输入和待输出的数据都被处理完，则返回 Z_STREAM_END</span></span><br><span class="line">        <span class="type">size_t</span> have = CHUNK - strm.avail_out;<span class="comment">//总长度-当前可写=已经写的数据长度</span></span><br><span class="line">        output.<span class="built_in">append</span>(out, have);</span><br><span class="line">    &#125; <span class="keyword">while</span> (strm.avail_out == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">deflateEnd</span>(&amp;strm);                       <span class="comment">//释放deflateInit2申请的空间</span></span><br><span class="line">    LOG_INFO&lt;&lt;<span class="string">&quot;原始的数据大小为:&quot;</span>&lt;&lt; input.<span class="built_in">size</span>();</span><br><span class="line">    LOG_INFO&lt;&lt;<span class="string">&quot;GZIP压缩完成,压缩比例为:&quot;</span>&lt;&lt;(<span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(output.<span class="built_in">size</span>()) / input.<span class="built_in">size</span>());;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GzipMiddleware::checkArchive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果压缩的总请求数或原始数据累计大小超过阈值</span></span><br><span class="line">    <span class="comment">// 就清理统计数据（可用于后续监控、日志）</span></span><br><span class="line">    <span class="keyword">if</span> (totalRequests_ &gt;= MAX_REQUESTS_BEFORE_ARCHIVE ||</span><br><span class="line">        originalSizeSum_ &gt;= MAX_ORIGINAL_SIZE_BEFORE_ARCHIVE) &#123;</span><br><span class="line"></span><br><span class="line">        totalRequests_ = <span class="number">0</span>;</span><br><span class="line">        gzipAppliedCount_ = <span class="number">0</span>;</span><br><span class="line">        originalSizeSum_ = <span class="number">0</span>;</span><br><span class="line">        compressedSizeSum_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现的函数有：</p>
<ul>
<li><code>before()</code>函数，判断请求是否支持gzip压缩</li>
<li><code>after()</code>函数，统计请求，如果客户端不支持gzip压缩就返回；否则对其进行gzip压缩并填充响应体部分</li>
<li><code>compressGzip()</code>函数，实际的压缩处理核心部分</li>
<li><code>checkArchive()</code>函数，用于统计压缩的情况，如平均压缩率等</li>
</ul>
<p>本代码实现<code>gzip</code>的核心部分就是在<code>compressGzip</code>函数中进行了实际的压缩，<code>compressGzip</code>调用了<code>deflate</code>函数进行实际的压缩。关于<code>deflate</code>函数的介绍，可以参考<br><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_61476090/article/details/136592993" >深入理解数据压缩流程及 zlib 库中相关函数<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="运行分析"><a href="#运行分析" class="headerlink" title="运行分析"></a>运行分析</h2><p>运行服务器，查看gzip压缩是否启用成功，有三个地方可以查看gzip的压缩启用是否成功。分别是日志系统、wireshark抓包分析、LiteHub前端展示。</p>
<h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><p><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/53ab09d1730c4a34a4e47c85840f2ed9.png"
                        alt="在这里插入图片描述"
                 ><br>这个压缩比例计算方式是：压缩后的数据大小除以压缩前的数据大小。可以看到gzip是有效压缩成功了的。</p>
<h3 id="wireshark抓包查看"><a href="#wireshark抓包查看" class="headerlink" title="wireshark抓包查看"></a>wireshark抓包查看</h3><p><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/01844c8007ad426badcf683ae73e916f.png"
                        alt="在这里插入图片描述"
                 ><br>首先看客户端发起的每一次请求都会携带<code>Accept-Encoding:</code>字段，该字段中携带了 <code>gzip, deflate</code>表示支持<code>gzip</code>压缩方式。</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/dede28be630f4f83839cfd4b59dc07a8.png"
                        alt="在这里插入图片描述"
                 ><br>这个报文是从服务器发回的响应报文，客户端收到压缩后的信息包后自动解压，从2380字节解压到原来的9182字节，这也进一步说明了设计的gzip压缩算法是有效的。</p>
<h3 id="后台管理界面查看"><a href="#后台管理界面查看" class="headerlink" title="后台管理界面查看"></a>后台管理界面查看</h3><p>此外，在LiteHub前端界面，也是可以通过管理员账户查看具体的gzip的一个压缩信息的。<br><img  
                       lazyload
                       alt="image"
                       data-src="https://i-blog.csdnimg.cn/direct/83851fc1911e4c46a9cd62699348187a.png"
                        alt="在这里插入图片描述"
                 ><br>关于gzip的理解就分析到这了，如果有不恰当之前，请您指出。</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E7%BD%91%E7%BB%9C/">网络</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%90%8E%E7%AB%AF/">后端</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="分享到 QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="分享到微信"
            data-tooltip-img-tip="微信扫一扫"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="分享到微博"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/undefined/LiteHub_databasepool/"
                                   title="LiteHub之数据库连接池"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">LiteHub之数据库连接池</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/undefined/stl_iterator/"
                                   title="STL迭代器的理解"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">STL迭代器的理解</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%AE%BA%E9%83%A8%E5%88%86"><span class="nav-text">理论部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LZ777%E7%AE%97%E6%B3%95"><span class="nav-text">LZ777算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%8D%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81%E7%AE%97%E6%B3%95"><span class="nav-text">霍夫曼编码算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E8%BF%9B%E5%9E%8B%E7%9A%84LZ777%E7%AE%97%E6%B3%95"><span class="nav-text">改进型的LZ777算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E5%AF%B9%E8%B1%A1"><span class="nav-text">压缩对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip%E5%AE%9E%E7%8E%B0"><span class="nav-text">gzip实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-text">运行分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B"><span class="nav-text">日志查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wireshark%E6%8A%93%E5%8C%85%E6%9F%A5%E7%9C%8B"><span class="nav-text">wireshark抓包查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E6%9F%A5%E7%9C%8B"><span class="nav-text">后台管理界面查看</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Qingyh</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">31k</span>
                </span>
            

            

            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%AE%BA%E9%83%A8%E5%88%86"><span class="nav-text">理论部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LZ777%E7%AE%97%E6%B3%95"><span class="nav-text">LZ777算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%8D%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81%E7%AE%97%E6%B3%95"><span class="nav-text">霍夫曼编码算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E8%BF%9B%E5%9E%8B%E7%9A%84LZ777%E7%AE%97%E6%B3%95"><span class="nav-text">改进型的LZ777算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E5%AF%B9%E8%B1%A1"><span class="nav-text">压缩对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip%E5%AE%9E%E7%8E%B0"><span class="nav-text">gzip实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-text">运行分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B"><span class="nav-text">日志查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wireshark%E6%8A%93%E5%8C%85%E6%9F%A5%E7%9C%8B"><span class="nav-text">wireshark抓包查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E6%9F%A5%E7%9C%8B"><span class="nav-text">后台管理界面查看</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/post/share.min.js"></script>
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



    
        
    

</body>
</html>
